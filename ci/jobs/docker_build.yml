docker_build:
  stage: docker_build
  image: docker:latest 
  services:
    - docker:dind
  script:
    - apk add --no-cache python3 py3-pip
    - apk add --no-cache aws-cli
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR
    - docker build -t $APP_NAME .
    - docker tag $APP_NAME:latest $ECR_REPO:latest
    - docker tag $APP_NAME:latest $ECR_REPO:$IMAGE_TAG
    - docker push $ECR_REP:latest
    - docker push $ECR_REPO:$IMAGE_TAG
  only:
    - main
  needs: ["docker_linting", "semgrep_scan"]

